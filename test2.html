<html>
<body style="background-color: #111;">

<pre><font style="background-color: #444444">───────┬────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</font>
       <font style="background-color: #444444">│ </font>File: <b>cadistributor/jobs.py</b>
<font style="background-color: #444444">───────┼────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</font>
   <font style="background-color: #444444">1</font>   <font style="background-color: #444444">│</font> 
   <font style="background-color: #444444">2</font>   <font style="background-color: #444444">│</font> <font style="background-color: #F92672">from</font> <font style="background-color: #F8F8F2"></font><font style="background-color: #F92672">.</font> <font style="background-color: #F8F8F2"></font><font style="background-color: #F92672">import</font> <font style="background-color: #F8F8F2">log</font>
   <font style="background-color: #444444">3</font>   <font style="background-color: #444444">│</font> <font style="background-color: #F92672">import</font> <font style="background-color: #F8F8F2">pymongo</font>
   <font style="background-color: #444444">4</font>   <font style="background-color: #444444">│</font> <font style="background-color: #F92672">from</font> <font style="background-color: #F8F8F2">pymongo.mongo_client </font><font style="background-color: #F92672">import</font> <font style="background-color: #F8F8F2">MongoClient</font>
   <font style="background-color: #444444">5</font>   <font style="background-color: #444444">│</font> <font style="background-color: #F92672">import</font> <font style="background-color: #F8F8F2">bson, json, datetime</font>
   <font style="background-color: #444444">6</font>   <font style="background-color: #444444">│</font> <font style="background-color: #F92672">from</font> <font style="background-color: #F8F8F2">bson.objectid </font><font style="background-color: #F92672">import</font> <font style="background-color: #F8F8F2">ObjectId</font>
   <font style="background-color: #444444">7</font>   <font style="background-color: #444444">│</font> <font style="background-color: #F92672">from</font> <font style="background-color: #F8F8F2">bson.json_util </font><font style="background-color: #F92672">import</font> <font style="background-color: #F8F8F2">loads, dumps</font>
   <font style="background-color: #444444">8</font>   <font style="background-color: #444444">│</font> 
   <font style="background-color: #444444">9</font>   <font style="background-color: #444444">│</font> 
  <font style="background-color: #444444">10</font>   <font style="background-color: #444444">│</font> <font style="background-color: #F8F8F2">jobtemplate </font><font style="background-color: #F92672">=</font> <font style="background-color: #F8F8F2">{</font>
  <font style="background-color: #444444">11</font>   <font style="background-color: #444444">│</font>     <font style="background-color: #F8F8F2"></font><font style="background-color: #E6DB74">&quot;url&quot;</font> <font style="background-color: #F8F8F2">: </font><font style="background-color: #BE84FF">None</font><font style="background-color: #F8F8F2">,</font>
  <font style="background-color: #444444">12</font>   <font style="background-color: #444444">│</font>     <font style="background-color: #F8F8F2"></font><font style="background-color: #E6DB74">&quot;name&quot;</font> <font style="background-color: #F8F8F2">: </font><font style="background-color: #BE84FF">None</font><font style="background-color: #F8F8F2">,</font>
  <font style="background-color: #444444">13</font>   <font style="background-color: #444444">│</font>     <font style="background-color: #F8F8F2"></font><font style="background-color: #E6DB74">&quot;target_commit&quot;</font> <font style="background-color: #F8F8F2">: </font><font style="background-color: #BE84FF">None</font><font style="background-color: #F8F8F2">,</font>
  <font style="background-color: #444444">14</font>   <font style="background-color: #444444">│</font>     <font style="background-color: #F8F8F2"></font><font style="background-color: #E6DB74">&quot;target_commit_date&quot;</font> <font style="background-color: #F8F8F2">: </font><font style="background-color: #BE84FF">None</font><font style="background-color: #F8F8F2">,</font>
  <font style="background-color: #444444">15</font>   <font style="background-color: #444444">│</font>     <font style="background-color: #F8F8F2"></font><font style="background-color: #E6DB74">&quot;status&quot;</font> <font style="background-color: #F8F8F2">: </font><font style="background-color: #E6DB74">&quot;unclaimed&quot;</font><font style="background-color: #F8F8F2">,</font>
  <font style="background-color: #444444">16</font>   <font style="background-color: #444444">│</font>     <font style="background-color: #F8F8F2"></font><font style="background-color: #E6DB74">&quot;worker&quot;</font> <font style="background-color: #F8F8F2">: </font><font style="background-color: #BE84FF">None</font><font style="background-color: #F8F8F2">,</font>
  <font style="background-color: #444444">17</font>   <font style="background-color: #444444">│</font>     <font style="background-color: #F8F8F2"></font><font style="background-color: #E6DB74">&quot;source&quot;</font> <font style="background-color: #F8F8F2">: </font><font style="background-color: #BE84FF">None</font>
  <font style="background-color: #444444">18</font>   <font style="background-color: #444444">│</font> <font style="background-color: #F8F8F2">}</font>
  <font style="background-color: #444444">19</font>   <font style="background-color: #444444">│</font> 
  <font style="background-color: #444444">20</font>   <font style="background-color: #444444">│</font> <font style="background-color: #F8F8F2">dbclient </font><font style="background-color: #F92672">=</font> <font style="background-color: #F8F8F2">MongoClient()</font>
  <font style="background-color: #444444">21</font>   <font style="background-color: #444444">│</font> <font style="background-color: #F8F8F2">db </font><font style="background-color: #F92672">=</font> <font style="background-color: #F8F8F2">dbclient.get_database(</font><font style="background-color: #FD971F">name</font><font style="background-color: #F92672">=</font><font style="background-color: #E6DB74">&apos;ca-core&apos;</font><font style="background-color: #F8F8F2">)</font>
  <font style="background-color: #444444">22</font>   <font style="background-color: #444444">│</font> <font style="background-color: #F8F8F2">jobcollection </font><font style="background-color: #F92672">=</font> <font style="background-color: #F8F8F2">db.get_collection(</font><font style="background-color: #E6DB74">&apos;jobs&apos;</font><font style="background-color: #F8F8F2">)</font>
  <font style="background-color: #444444">23</font>   <font style="background-color: #444444">│</font> <font style="background-color: #F8F8F2">workercollection </font><font style="background-color: #F92672">=</font> <font style="background-color: #F8F8F2">db.get_collection(</font><font style="background-color: #E6DB74">&apos;workers&apos;</font><font style="background-color: #F8F8F2">)</font>
  <font style="background-color: #444444">24</font>   <font style="background-color: #444444">│</font> 
  <font style="background-color: #444444">25</font>   <font style="background-color: #444444">│</font> <font style="background-color: #75715E">### workercollection</font>
  <font style="background-color: #444444">26</font>   <font style="background-color: #444444">│</font> 
  <font style="background-color: #444444">27</font>   <font style="background-color: #444444">│</font> <font style="background-color: #A6E22E">def</font> <font style="background-color: #F8F8F2"></font><font style="background-color: #A6E22E">get_worker_state</font><font style="background-color: #F8F8F2">(</font><font style="background-color: #FD971F">workername</font><font style="background-color: #F8F8F2">):</font>
  <font style="background-color: #444444">28</font>   <font style="background-color: #444444">│</font>     <font style="background-color: #F8F8F2"></font><font style="background-color: #F92672">try</font><font style="background-color: #F8F8F2">:</font>
  <font style="background-color: #444444">29</font>   <font style="background-color: #444444">│</font>         <font style="background-color: #F8F8F2">result </font><font style="background-color: #F92672">=</font> <font style="background-color: #F8F8F2">workercollection.find_one({</font>
  <font style="background-color: #444444">30</font>   <font style="background-color: #444444">│</font>             <font style="background-color: #F8F8F2"></font><font style="background-color: #E6DB74">&quot;name&quot;</font><font style="background-color: #F8F8F2">: workername</font>
  <font style="background-color: #444444">31</font>   <font style="background-color: #444444">│</font>         <font style="background-color: #F8F8F2">})</font>
  <font style="background-color: #444444">32</font>   <font style="background-color: #444444">│</font>         <font style="background-color: #F8F8F2"></font><font style="background-color: #F92672">if</font> <font style="background-color: #F8F8F2">result </font><font style="background-color: #F92672">is</font> <font style="background-color: #F8F8F2"></font><font style="background-color: #BE84FF">None</font><font style="background-color: #F8F8F2">:</font>
  <font style="background-color: #444444">33</font>   <font style="background-color: #444444">│</font>             <font style="background-color: #F8F8F2"></font><font style="background-color: #F92672">return</font> <font style="background-color: #F8F8F2"></font><font style="background-color: #BE84FF">404</font>
  <font style="background-color: #444444">34</font>   <font style="background-color: #444444">│</font>         <font style="background-color: #F8F8F2"></font><font style="background-color: #F92672">return</font> <font style="background-color: #F8F8F2">result[</font><font style="background-color: #E6DB74">&quot;state&quot;</font><font style="background-color: #F8F8F2">]</font>
  <font style="background-color: #444444">35</font>   <font style="background-color: #444444">│</font>     <font style="background-color: #F8F8F2"></font><font style="background-color: #F92672">except</font> <font style="background-color: #F8F8F2"></font><font style="background-color: #66D9EF">Exception</font> <font style="background-color: #F8F8F2"></font><font style="background-color: #F92672">as</font> <font style="background-color: #F8F8F2">e:</font>
  <font style="background-color: #444444">36</font>   <font style="background-color: #444444">│</font>         <font style="background-color: #F8F8F2">log.err(e)</font>
  <font style="background-color: #444444">37</font>   <font style="background-color: #444444">│</font>         <font style="background-color: #F8F8F2"></font><font style="background-color: #F92672">raise</font> <font style="background-color: #F8F8F2">e</font>
  <font style="background-color: #444444">38</font>   <font style="background-color: #444444">│</font> 
  <font style="background-color: #444444">39</font>   <font style="background-color: #444444">│</font> <font style="background-color: #A6E22E">def</font> <font style="background-color: #F8F8F2"></font><font style="background-color: #A6E22E">get_worker_token</font><font style="background-color: #F8F8F2">(</font><font style="background-color: #FD971F">workername</font><font style="background-color: #F8F8F2">):</font>
  <font style="background-color: #444444">40</font>   <font style="background-color: #444444">│</font>     <font style="background-color: #F8F8F2"></font><font style="background-color: #F92672">try</font><font style="background-color: #F8F8F2">:</font>
  <font style="background-color: #444444">41</font>   <font style="background-color: #444444">│</font>         <font style="background-color: #F8F8F2">result </font><font style="background-color: #F92672">=</font> <font style="background-color: #F8F8F2">workercollection.find_one({</font>
  <font style="background-color: #444444">42</font>   <font style="background-color: #444444">│</font>             <font style="background-color: #F8F8F2"></font><font style="background-color: #E6DB74">&quot;name&quot;</font><font style="background-color: #F8F8F2">: workername</font>
  <font style="background-color: #444444">43</font>   <font style="background-color: #444444">│</font>         <font style="background-color: #F8F8F2">})</font>
  <font style="background-color: #444444">44</font>   <font style="background-color: #444444">│</font>         <font style="background-color: #F8F8F2"></font><font style="background-color: #F92672">if</font> <font style="background-color: #F8F8F2">result </font><font style="background-color: #F92672">is</font> <font style="background-color: #F8F8F2"></font><font style="background-color: #BE84FF">None</font><font style="background-color: #F8F8F2">:</font>
  <font style="background-color: #444444">45</font>   <font style="background-color: #444444">│</font>             <font style="background-color: #F8F8F2"></font><font style="background-color: #F92672">return</font> <font style="background-color: #F8F8F2"></font><font style="background-color: #BE84FF">None</font> <font style="background-color: #F8F8F2"></font><font style="background-color: #75715E"># unauthorized</font>
  <font style="background-color: #444444">46</font>   <font style="background-color: #444444">│</font>         <font style="background-color: #F8F8F2"></font><font style="background-color: #F92672">return</font> <font style="background-color: #F8F8F2">result[</font><font style="background-color: #E6DB74">&quot;token&quot;</font><font style="background-color: #F8F8F2">]</font>
  <font style="background-color: #444444">47</font>   <font style="background-color: #444444">│</font>     <font style="background-color: #F8F8F2"></font><font style="background-color: #F92672">except</font> <font style="background-color: #F8F8F2"></font><font style="background-color: #66D9EF">Exception</font> <font style="background-color: #F8F8F2"></font><font style="background-color: #F92672">as</font> <font style="background-color: #F8F8F2">e:</font>
  <font style="background-color: #444444">48</font>   <font style="background-color: #444444">│</font>         <font style="background-color: #F8F8F2">log.err(e)</font>
  <font style="background-color: #444444">49</font>   <font style="background-color: #444444">│</font>         <font style="background-color: #F8F8F2"></font><font style="background-color: #F92672">return</font> <font style="background-color: #F8F8F2"></font><font style="background-color: #BE84FF">None</font>
  <font style="background-color: #444444">50</font>   <font style="background-color: #444444">│</font> 
  <font style="background-color: #444444">51</font>   <font style="background-color: #444444">│</font> <font style="background-color: #A6E22E">def</font> <font style="background-color: #F8F8F2"></font><font style="background-color: #A6E22E">update_worker_state</font><font style="background-color: #F8F8F2">(</font><font style="background-color: #FD971F">workername</font><font style="background-color: #F8F8F2">, </font><font style="background-color: #FD971F">state</font><font style="background-color: #F8F8F2">):</font>
  <font style="background-color: #444444">52</font>   <font style="background-color: #444444">│</font>     <font style="background-color: #F8F8F2"></font><font style="background-color: #F92672">try</font><font style="background-color: #F8F8F2">:</font>
  <font style="background-color: #444444">53</font>   <font style="background-color: #444444">│</font>         <font style="background-color: #F8F8F2">worker </font><font style="background-color: #F92672">=</font> <font style="background-color: #F8F8F2">workercollection.find_one_and_update({</font>
</pre>

</body>
</html>
